# XString

Implement small string optimization and copy-on-write on c char string.
This project is reference from [sysprog](https://hackmd.io/@sysprog/linux2020-quiz2) and [folly::fbstring](https://github.com/facebook/folly/blob/master/folly/FBString.h)

## Evaluation

### Memory Usage
Use valgrind to evaluate memory usage.

* Copy-on-write
```
    KB
168.3^                                    #
     |                                  ::#:
     |                                ::: #::@
     |                               :::: #::@::
     |                             :::::: #::@:::
     |                           :::::::: #::@:::::
     |                         @::::::::: #::@:::::::
     |                       ::@::::::::: #::@::::::::@
     |                      @::@::::::::: #::@::::::::@:
     |                    ::@::@::::::::: #::@::::::::@:::
     |                  @:::@::@::::::::: #::@::::::::@:::::
     |                ::@:::@::@::::::::: #::@::::::::@:::::@:
     |              ::::@:::@::@::::::::: #::@::::::::@:::::@:::
     |            @@::::@:::@::@::::::::: #::@::::::::@:::::@::::
     |          ::@ ::::@:::@::@::::::::: #::@::::::::@:::::@:::::::
     |         :: @ ::::@:::@::@::::::::: #::@::::::::@:::::@:::::: @
     |         :: @ ::::@:::@::@::::::::: #::@::::::::@:::::@:::::: @::::::::
     |         :: @ ::::@:::@::@::::::::: #::@::::::::@:::::@:::::: @:
     |         :: @ ::::@:::@::@::::::::: #::@::::::::@:::::@:::::: @:
     |         :: @ ::::@:::@::@::::::::: #::@::::::::@:::::@:::::: @:
   0 +----------------------------------------------------------------------->KB
     0                                                                   336.6

--------------------------------------------------------------------------------
  n        time(B)         total(B)   useful-heap(B) extra-heap(B)    stacks(B)
--------------------------------------------------------------------------------
40        175,400          169,256          130,255        39,001            0
41        178,472          166,184          128,207        37,977            0
42        181,544          163,112          126,159        36,953            0
43        184,616          160,040          124,111        35,929            0
44        187,688          156,968          122,063        34,905            0
```

* Without copy-on-write
```
    MB
39.34^                                    #
     |                                   :#:
     |                                ::::#:::
     |                               @::::#:::@:
     |                             ::@::::#:::@::
     |                           @:::@::::#:::@:::@:
     |                         ::@:::@::::#:::@:::@::
     |                        :::@:::@::::#:::@:::@::::
     |                      :::::@:::@::::#:::@:::@::::::
     |                    :::::::@:::@::::#:::@:::@:::::@::
     |                  :::::::::@:::@::::#:::@:::@:::::@::::
     |                :::::::::::@:::@::::#:::@:::@:::::@::::::
     |              :::::::::::::@:::@::::#:::@:::@:::::@::::::@
     |            :::::::::::::::@:::@::::#:::@:::@:::::@::::::@::
     |           @:::::::::::::::@:::@::::#:::@:::@:::::@::::::@::::
     |         ::@:::::::::::::::@:::@::::#:::@:::@:::::@::::::@::::::
     |       ::::@:::::::::::::::@:::@::::#:::@:::@:::::@::::::@:::::@:
     |     :@::::@:::::::::::::::@:::@::::#:::@:::@:::::@::::::@:::::@:::
     |   :::@::::@:::::::::::::::@:::@::::#:::@:::@:::::@::::::@:::::@:::::
     |  @:::@::::@:::::::::::::::@:::@::::#:::@:::@:::::@::::::@:::::@::::::@
   0 +----------------------------------------------------------------------->MB
     0                                                                   78.13

--------------------------------------------------------------------------------
  n        time(B)         total(B)   useful-heap(B) extra-heap(B)    stacks(B)
--------------------------------------------------------------------------------
41     42,175,184       40,329,472       40,246,343        83,129            0
42     43,098,064       39,406,592       39,325,367        81,225            0
43     44,020,944       38,483,712       38,404,391        79,321            0
44     44,943,824       37,560,832       37,483,415        77,417            0
45     45,866,704       36,637,952       36,562,439        75,513            0
```

### Cache locality

Use perf to evaluate cache miss rate

* Copy-on-write
```
         1,580,885      cache-misses              #   99.520 % of all cache refs      ( +-  4.24% )  (29.98%)
         1,588,504      cache-references                                              ( +-  3.98% )  (40.01%)
     9,603,320,974      instructions              #    3.52  insns per cycle          ( +-  0.04% )  (50.02%)
     2,730,406,169      cycles                                                        ( +-  1.10% )  (50.03%)
         3,307,934      L1-dcache-load-misses     #    0.12% of all L1-dcache hits    ( +-  0.14% )  (50.10%)
     2,705,536,050      L1-dcache-loads                                               ( +-  0.04% )  (50.11%)
                 0      LLC-load-misses           #    0.00% of all LL-cache hits     (50.08%)
           120,628      LLC-loads                                                     ( +-  5.24% )  (40.07%)
                 0      LLC-store-misses                                              (20.00%)
             2,610      LLC-stores                                                    ( +-  9.06% )  (19.98%)

       1.061620998 seconds time elapsed                                          ( +-  1.12% )
 ```

* Without copy-on-write
```
       522,868,273      cache-misses              #   99.992 % of all cache refs      ( +-  0.07% )  (30.00%)
       522,907,590      cache-references                                              ( +-  0.06% )  (40.00%)
     9,811,732,941      instructions              #    1.51  insns per cycle          ( +-  0.02% )  (49.99%)
     6,500,761,996      cycles                                                        ( +-  0.17% )  (49.99%)
       337,318,781      L1-dcache-load-misses     #   12.26% of all L1-dcache hits    ( +-  0.01% )  (50.01%)
     2,752,201,354      L1-dcache-loads                                               ( +-  0.02% )  (50.02%)
                 0      LLC-load-misses           #    0.00% of all LL-cache hits     (50.03%)
        44,279,085      LLC-loads                                                     ( +-  0.98% )  (40.05%)
                 0      LLC-store-misses                                              (20.02%)
           580,570      LLC-stores                                                    ( +-  1.10% )  (19.99%)

       2.536418567 seconds time elapsed                                          ( +-  0.12% )
```

### Benchmark
![image](https://github.com/kaivenhu/sysprog21/blob/master/xstring/picture/xstring-benchmark.png)




